---
import Layout from '../layouts/Layout.astro';
---

<Layout>
	<div class="w-screen h-screen bg-page overflow-y-auto custom-scrollbar">
		<div class="max-w-[1200px] mx-auto p-10 space-y-8">
			<!-- Title -->
			<div class="flex items-center justify-between">
				<h1 class="text-white text-[28px] font-bold">API Settings</h1>
				<button
					onclick="window.location.href='/'"
					class="px-6 py-2 bg-card border border-primary rounded-[12px] text-white font-medium
					       hover:border-glow transition-colors cursor-pointer"
				>
					Back
				</button>
			</div>

			<!-- Active Provider Card -->
			<div class="bg-card border border-primary rounded-[20px] p-7">
				<h2 class="text-white text-lg font-bold mb-6">Active Provider</h2>

				<div id="active-provider-loading" class="text-muted text-center py-4">
					Loading...
				</div>

				<div id="active-provider-info" class="hidden">
					<div class="flex items-center justify-between">
						<div class="flex items-center gap-4">
							<div id="active-provider-icon" class="w-12 h-12 gradient-primary rounded-[12px] flex items-center justify-center">
								<svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
										d="M13 10V3L4 14h7v7l9-11h-7z"/>
								</svg>
							</div>
							<div>
								<div id="active-provider-name" class="text-white text-xl font-bold">-</div>
								<div id="active-provider-model" class="text-muted text-sm">-</div>
							</div>
						</div>
						<div id="active-provider-status" class="px-4 py-2 rounded-full text-sm font-medium bg-input text-muted">
							Not Connected
						</div>
					</div>
				</div>
			</div>

			<!-- Provider Cards -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<!-- OpenAI -->
				<div class="provider-card bg-card border border-primary rounded-[20px] p-7" data-provider="OpenAI">
					<div class="flex items-center justify-between mb-6">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 bg-[#00A67E] rounded-[10px] flex items-center justify-center text-white font-bold">
								O
							</div>
							<div>
								<h3 class="text-white font-bold">OpenAI</h3>
								<p class="text-muted text-xs">GPT-4o, GPT-4 Turbo</p>
							</div>
						</div>
						<div class="provider-status px-3 py-1 rounded-full text-xs font-medium bg-input text-muted">
							Not Configured
						</div>
					</div>

					<div class="space-y-4">
						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">API Key</label>
							<div class="flex gap-2">
								<input
									type="password"
									class="api-key-input flex-1 h-10 bg-input rounded-[12px] px-4 text-white text-sm
									       border-none outline-none font-mono"
									placeholder="sk-..."
								/>
								<button
									class="btn-toggle-visibility p-2 bg-input rounded-[10px] text-muted hover:text-white transition-colors"
								>
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
									</svg>
								</button>
							</div>
						</div>

						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">Model</label>
							<select class="model-select w-full h-10 bg-input rounded-[12px] px-4 text-white text-sm border-none outline-none">
								<option value="gpt-4o">GPT-4o</option>
								<option value="gpt-4-turbo">GPT-4 Turbo</option>
								<option value="gpt-4">GPT-4</option>
								<option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
							</select>
						</div>

						<div class="flex gap-2 pt-2">
							<button class="btn-save flex-1 py-2 gradient-primary rounded-[10px] text-white font-medium text-sm
							               hover:opacity-90 transition-opacity cursor-pointer">
								Save
							</button>
							<button class="btn-test py-2 px-4 bg-input rounded-[10px] text-white font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer">
								Test
							</button>
							<button class="btn-activate py-2 px-4 bg-input rounded-[10px] text-success font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer disabled:opacity-50"
							        disabled>
								Activate
							</button>
						</div>
					</div>
				</div>

				<!-- Anthropic -->
				<div class="provider-card bg-card border border-primary rounded-[20px] p-7" data-provider="Anthropic">
					<div class="flex items-center justify-between mb-6">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 bg-[#CC785C] rounded-[10px] flex items-center justify-center text-white font-bold">
								A
							</div>
							<div>
								<h3 class="text-white font-bold">Anthropic</h3>
								<p class="text-muted text-xs">Claude 3.5 Sonnet, Claude 3 Opus</p>
							</div>
						</div>
						<div class="provider-status px-3 py-1 rounded-full text-xs font-medium bg-input text-muted">
							Not Configured
						</div>
					</div>

					<div class="space-y-4">
						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">API Key</label>
							<div class="flex gap-2">
								<input
									type="password"
									class="api-key-input flex-1 h-10 bg-input rounded-[12px] px-4 text-white text-sm
									       border-none outline-none font-mono"
									placeholder="sk-ant-..."
								/>
								<button
									class="btn-toggle-visibility p-2 bg-input rounded-[10px] text-muted hover:text-white transition-colors"
								>
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
									</svg>
								</button>
							</div>
						</div>

						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">Model</label>
							<select class="model-select w-full h-10 bg-input rounded-[12px] px-4 text-white text-sm border-none outline-none">
								<option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
								<option value="claude-3-opus-20240229">Claude 3 Opus</option>
								<option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
								<option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
							</select>
						</div>

						<div class="flex gap-2 pt-2">
							<button class="btn-save flex-1 py-2 gradient-primary rounded-[10px] text-white font-medium text-sm
							               hover:opacity-90 transition-opacity cursor-pointer">
								Save
							</button>
							<button class="btn-test py-2 px-4 bg-input rounded-[10px] text-white font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer">
								Test
							</button>
							<button class="btn-activate py-2 px-4 bg-input rounded-[10px] text-success font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer disabled:opacity-50"
							        disabled>
								Activate
							</button>
						</div>
					</div>
				</div>

				<!-- Google AI -->
				<div class="provider-card bg-card border border-primary rounded-[20px] p-7" data-provider="Google">
					<div class="flex items-center justify-between mb-6">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 bg-[#4285F4] rounded-[10px] flex items-center justify-center text-white font-bold">
								G
							</div>
							<div>
								<h3 class="text-white font-bold">Google AI</h3>
								<p class="text-muted text-xs">Gemini 1.5 Flash, Gemini 1.5 Pro</p>
							</div>
						</div>
						<div class="provider-status px-3 py-1 rounded-full text-xs font-medium bg-input text-muted">
							Not Configured
						</div>
					</div>

					<div class="space-y-4">
						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">API Key</label>
							<div class="flex gap-2">
								<input
									type="password"
									class="api-key-input flex-1 h-10 bg-input rounded-[12px] px-4 text-white text-sm
									       border-none outline-none font-mono"
									placeholder="AIza..."
								/>
								<button
									class="btn-toggle-visibility p-2 bg-input rounded-[10px] text-muted hover:text-white transition-colors"
								>
									<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
											d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
									</svg>
								</button>
							</div>
						</div>

						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">Model</label>
							<select class="model-select w-full h-10 bg-input rounded-[12px] px-4 text-white text-sm border-none outline-none">
								<option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
								<option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
								<option value="gemini-pro">Gemini Pro</option>
							</select>
						</div>

						<div class="flex gap-2 pt-2">
							<button class="btn-save flex-1 py-2 gradient-primary rounded-[10px] text-white font-medium text-sm
							               hover:opacity-90 transition-opacity cursor-pointer">
								Save
							</button>
							<button class="btn-test py-2 px-4 bg-input rounded-[10px] text-white font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer">
								Test
							</button>
							<button class="btn-activate py-2 px-4 bg-input rounded-[10px] text-success font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer disabled:opacity-50"
							        disabled>
								Activate
							</button>
						</div>
					</div>
				</div>

				<!-- Local Model -->
				<div class="provider-card bg-card border border-primary rounded-[20px] p-7" data-provider="Local">
					<div class="flex items-center justify-between mb-6">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 bg-[#6B7280] rounded-[10px] flex items-center justify-center text-white font-bold">
								L
							</div>
							<div>
								<h3 class="text-white font-bold">Local Model</h3>
								<p class="text-muted text-xs">Ollama, LM Studio</p>
							</div>
						</div>
						<div class="provider-status px-3 py-1 rounded-full text-xs font-medium bg-input text-muted">
							Not Configured
						</div>
					</div>

					<div class="space-y-4">
						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">Base URL</label>
							<input
								type="text"
								class="base-url-input w-full h-10 bg-input rounded-[12px] px-4 text-white text-sm
								       border-none outline-none font-mono"
								placeholder="http://localhost:11434/api"
								value="http://localhost:11434/api"
							/>
						</div>

						<div class="space-y-2">
							<label class="text-muted text-xs font-semibold">Model</label>
							<input
								type="text"
								class="model-input w-full h-10 bg-input rounded-[12px] px-4 text-white text-sm
								       border-none outline-none font-mono"
								placeholder="llama3.2"
								value="llama3.2"
							/>
						</div>

						<div class="flex gap-2 pt-2">
							<button class="btn-save flex-1 py-2 gradient-primary rounded-[10px] text-white font-medium text-sm
							               hover:opacity-90 transition-opacity cursor-pointer">
								Save
							</button>
							<button class="btn-test py-2 px-4 bg-input rounded-[10px] text-white font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer">
								Test
							</button>
							<button class="btn-activate py-2 px-4 bg-input rounded-[10px] text-success font-medium text-sm
							               hover:bg-secondary transition-colors cursor-pointer disabled:opacity-50"
							        disabled>
								Activate
							</button>
						</div>
					</div>
				</div>
			</div>

			<!-- Reset Button -->
			<div class="flex justify-center">
				<button
					id="btn-reset"
					class="px-8 py-3 bg-card border border-primary rounded-[24px] text-muted font-medium
					       hover:border-red-500 hover:text-red-500 transition-colors cursor-pointer"
				>
					Reset All Settings
				</button>
			</div>
		</div>
	</div>

	<script>
		import { invoke } from '@tauri-apps/api/core';

		// Types
		interface ProviderSummary {
			provider: string;
			display_name: string;
			enabled: boolean;
			has_api_key: boolean;
			masked_api_key: string | null;
			model: string;
			base_url: string;
		}

		interface AIConfigSummary {
			active_provider: string;
			providers: ProviderSummary[];
		}

		interface ApiResponse<T> {
			success: boolean;
			data?: T;
			error?: string;
		}

		// Load config summary
		async function loadConfigSummary() {
			try {
				const response = await invoke<ApiResponse<AIConfigSummary>>('get_ai_config_summary');

				if (response.success && response.data) {
					const config = response.data;

					document.getElementById('active-provider-loading')?.classList.add('hidden');
					document.getElementById('active-provider-info')?.classList.remove('hidden');

					// Update active provider info
					const activeProvider = config.providers.find(p => p.provider === config.active_provider);
					if (activeProvider) {
						document.getElementById('active-provider-name')!.textContent = activeProvider.display_name;
						document.getElementById('active-provider-model')!.textContent = activeProvider.model;

						const statusEl = document.getElementById('active-provider-status')!;
						if (activeProvider.has_api_key || activeProvider.provider === 'Local') {
							statusEl.textContent = 'Connected';
							statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium bg-green-500/20 text-success';
						} else {
							statusEl.textContent = 'Not Connected';
							statusEl.className = 'px-4 py-2 rounded-full text-sm font-medium bg-input text-muted';
						}
					}

					// Update provider cards
					config.providers.forEach(provider => {
						const card = document.querySelector(`.provider-card[data-provider="${provider.provider}"]`);
						if (!card) return;

						const statusEl = card.querySelector('.provider-status') as HTMLElement;
						const activateBtn = card.querySelector('.btn-activate') as HTMLButtonElement;

						if (provider.has_api_key || (provider.provider === 'Local' && provider.enabled)) {
							statusEl.textContent = provider.provider === config.active_provider ? 'Active' : 'Configured';
							statusEl.className = provider.provider === config.active_provider
								? 'provider-status px-3 py-1 rounded-full text-xs font-medium gradient-success text-white'
								: 'provider-status px-3 py-1 rounded-full text-xs font-medium bg-green-500/20 text-success';
							activateBtn.disabled = provider.provider === config.active_provider;
						}

						// Set model select
						const modelSelect = card.querySelector('.model-select') as HTMLSelectElement | null;
						if (modelSelect) {
							modelSelect.value = provider.model;
						}

						const modelInput = card.querySelector('.model-input') as HTMLInputElement | null;
						if (modelInput) {
							modelInput.value = provider.model;
						}

						const baseUrlInput = card.querySelector('.base-url-input') as HTMLInputElement | null;
						if (baseUrlInput) {
							baseUrlInput.value = provider.base_url;
						}
					});
				}
			} catch (error) {
				console.error('Failed to load config:', error);
			}
		}

		// Save provider config
		async function saveProvider(provider: string, apiKey: string | null, model: string, baseUrl?: string) {
			try {
				// First update API key if provided
				if (apiKey !== null) {
					const keyResponse = await invoke<ApiResponse<boolean>>('update_ai_api_key', {
						provider,
						apiKey: apiKey || null
					});

					if (!keyResponse.success) {
						throw new Error(keyResponse.error || 'Failed to update API key');
					}
				}

				// Then update full config
				const configResponse = await invoke<ApiResponse<boolean>>('update_ai_provider_config', {
					provider,
					configUpdate: {
						provider,
						api_key: apiKey || null,
						base_url: baseUrl || '',
						model,
						enabled: !!apiKey || provider === 'Local',
						max_tokens: 4096,
						temperature: 0.7
					}
				});

				if (configResponse.success) {
					await loadConfigSummary();
					showNotification('Configuration saved', 'success');
				} else {
					throw new Error(configResponse.error || 'Failed to save config');
				}
			} catch (error) {
				console.error('Save failed:', error);
				showNotification('Failed to save: ' + error, 'error');
			}
		}

		// Test provider connection
		async function testProvider(provider: string) {
			try {
				showNotification('Testing connection...', 'info');

				const response = await invoke<ApiResponse<string>>('test_ai_connection', { provider });

				if (response.success) {
					showNotification(response.data || 'Connection successful', 'success');
				} else {
					showNotification(response.error || 'Connection failed', 'error');
				}
			} catch (error) {
				console.error('Test failed:', error);
				showNotification('Test failed: ' + error, 'error');
			}
		}

		// Activate provider
		async function activateProvider(provider: string) {
			try {
				const response = await invoke<ApiResponse<boolean>>('set_active_ai_provider', { provider });

				if (response.success) {
					await loadConfigSummary();
					showNotification(`${provider} activated`, 'success');
				} else {
					throw new Error(response.error || 'Failed to activate');
				}
			} catch (error) {
				console.error('Activation failed:', error);
				showNotification('Activation failed: ' + error, 'error');
			}
		}

		// Reset config
		async function resetConfig() {
			if (!confirm('This will reset all API settings. Continue?')) return;

			try {
				const response = await invoke<ApiResponse<boolean>>('reset_ai_config');

				if (response.success) {
					await loadConfigSummary();
					// Clear all inputs
					document.querySelectorAll('.api-key-input').forEach((input) => {
						(input as HTMLInputElement).value = '';
					});
					showNotification('Settings reset', 'success');
				}
			} catch (error) {
				console.error('Reset failed:', error);
				showNotification('Reset failed: ' + error, 'error');
			}
		}

		// Simple notification
		function showNotification(message: string, type: 'success' | 'error' | 'info') {
			const notification = document.createElement('div');
			notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-[12px] text-white font-medium z-50 transition-all
				${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`;
			notification.textContent = message;
			document.body.appendChild(notification);

			setTimeout(() => {
				notification.remove();
			}, 3000);
		}

		// Initialize
		document.addEventListener('DOMContentLoaded', () => {
			loadConfigSummary();

			// Provider card handlers
			document.querySelectorAll('.provider-card').forEach(card => {
				const provider = (card as HTMLElement).dataset.provider || '';

				// Toggle visibility
				card.querySelector('.btn-toggle-visibility')?.addEventListener('click', () => {
					const input = card.querySelector('.api-key-input') as HTMLInputElement;
					input.type = input.type === 'password' ? 'text' : 'password';
				});

				// Save
				card.querySelector('.btn-save')?.addEventListener('click', () => {
					const apiKeyInput = card.querySelector('.api-key-input') as HTMLInputElement | null;
					const modelSelect = card.querySelector('.model-select') as HTMLSelectElement | null;
					const modelInput = card.querySelector('.model-input') as HTMLInputElement | null;
					const baseUrlInput = card.querySelector('.base-url-input') as HTMLInputElement | null;

					const apiKey = apiKeyInput?.value || null;
					const model = modelSelect?.value || modelInput?.value || '';
					const baseUrl = baseUrlInput?.value;

					saveProvider(provider, apiKey, model, baseUrl);
				});

				// Test
				card.querySelector('.btn-test')?.addEventListener('click', () => {
					testProvider(provider);
				});

				// Activate
				card.querySelector('.btn-activate')?.addEventListener('click', () => {
					activateProvider(provider);
				});
			});

			// Reset button
			document.getElementById('btn-reset')?.addEventListener('click', resetConfig);
		});
	</script>
</Layout>
