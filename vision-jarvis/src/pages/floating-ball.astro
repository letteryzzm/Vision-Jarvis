---
import '../styles/global.css';
import Ball from '../components/FloatingBall/Ball.astro';
import Header from '../components/FloatingBall/Header.astro';
import Asker from '../components/FloatingBall/Asker.astro';
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vision Jarvis</title>
</head>
<body style="margin: 0; padding: 0; background: transparent; overflow: hidden;">
  <!-- 垂直布局: Ball 在上，Expansion 在下 -->

  <!-- Ball Zone - 始终可见，Ball 靠右对齐 -->
  <div id="ball-zone" style="width: 100%; height: 64px; display: flex; align-items: center; justify-content: flex-end;">
    <Ball />
  </div>

  <!-- Expansion Zone - 动态显示，在 Ball 下方 -->
  <div id="expansion-zone" class="hidden" style="margin-top: 10px;">
    <!-- Header Expansion -->
    <div id="header-expansion" class="hidden">
      <Header />
    </div>

    <!-- Asker Expansion -->
    <div id="asker-expansion" class="hidden">
      <Asker />
    </div>
  </div>

  <script>
    import { invoke } from '@tauri-apps/api/core';
    import { $settings, loadSettings, toggleMemory } from '../stores/settingsStore';

    type WindowState = 'ball' | 'header' | 'asker';
    let currentState: WindowState = 'ball';
    let isTransitioning: boolean = false;
    let hoverTimer: number | null = null;
    let isInitialized: boolean = false; // 防止初始化时触发 hover

    // 窗口尺寸配置（新布局）
    const WINDOW_SIZES = {
      ball: { width: 64, height: 64 },           // 仅 Ball
      header: { width: 360, height: 146 },       // Ball(64) + gap(10) + Header(72)
      asker: { width: 360, height: 554 }         // Ball(64) + gap(10) + Asker(480)
    };

    // 获取展开区域元素
    function getExpansionZone(): HTMLElement | null {
      return document.getElementById('expansion-zone');
    }

    function getHeaderExpansion(): HTMLElement | null {
      return document.getElementById('header-expansion');
    }

    function getAskerExpansion(): HTMLElement | null {
      return document.getElementById('asker-expansion');
    }

    function getBallZone(): HTMLElement | null {
      return document.getElementById('ball-zone');
    }

    // 获取 resize 命令
    function getResizeCommand(state: WindowState): string {
      const commands = {
        'ball': 'collapse_to_ball',
        'header': 'expand_to_header',
        'asker': 'expand_to_asker'
      };
      return commands[state];
    }

    // 延迟函数
    function delay(ms: number): Promise<void> {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // updateBallZoneWidth 函数已移除 - Ball Zone 宽度固定为 64px

    // 切换到指定状态（带动画）
    async function switchTo(state: WindowState) {
      if (currentState === state || isTransitioning) return;

      isTransitioning = true;
      const previousState = currentState;

      try {
        const expansionZone = getExpansionZone();
        const headerExp = getHeaderExpansion();
        const askerExp = getAskerExpansion();

        // 1. 淡出当前展开内容（如果有）
        if (previousState !== 'ball') {
          const currentExp = previousState === 'header' ? headerExp : askerExp;
          currentExp?.classList.add('transitioning-out');
          await delay(150);
        }

        // 2. 调整窗口大小
        await invoke(getResizeCommand(state));

        // 3. 切换展开区域显示（Ball Zone 宽度保持 64px 不变）
        if (state === 'ball') {
          // 折叠: 隐藏 expansion zone
          expansionZone?.classList.add('hidden');
          headerExp?.classList.add('hidden');
          askerExp?.classList.add('hidden');
        } else {
          // 展开: 显示对应的 expansion
          expansionZone?.classList.remove('hidden');

          if (state === 'header') {
            headerExp?.classList.remove('hidden');
            headerExp?.classList.add('transitioning-in');
            askerExp?.classList.add('hidden');
          } else if (state === 'asker') {
            askerExp?.classList.remove('hidden');
            askerExp?.classList.add('transitioning-in');
            headerExp?.classList.add('hidden');
          }

          await delay(150);

          // 移除动画类
          headerExp?.classList.remove('transitioning-in', 'transitioning-out');
          askerExp?.classList.remove('transitioning-in', 'transitioning-out');
        }

        currentState = state;
      } catch (error) {
        console.error('Transition failed:', error);
        // Rollback
        currentState = previousState;
      } finally {
        isTransitioning = false;
      }
    }

    // ========================================
    // 事件处理 - 在 DOMContentLoaded 中注册
    // ========================================

    // 暂时不注册事件，等待 DOMContentLoaded

    // ========================================
    // 初始化
    // ========================================

    // 页面加载时确保初始状态正确
    window.addEventListener('DOMContentLoaded', () => {
      console.log('[Floating Ball] Page loaded, initializing...');
      console.log('[Floating Ball] Current state:', currentState);
      console.log('[Floating Ball] Expansion zone hidden:', getExpansionZone()?.classList.contains('hidden'));
      console.log('[Floating Ball] Header expansion hidden:', getHeaderExpansion()?.classList.contains('hidden'));
      console.log('[Floating Ball] Asker expansion hidden:', getAskerExpansion()?.classList.contains('hidden'));

      // 确保初始状态为 ball（所有展开区域都隐藏）
      const expansionZone = getExpansionZone();
      const headerExp = getHeaderExpansion();
      const askerExp = getAskerExpansion();

      if (expansionZone && !expansionZone.classList.contains('hidden')) {
        console.warn('[Floating Ball] Expansion zone is visible on load, hiding it');
        expansionZone.classList.add('hidden');
      }

      if (headerExp && !headerExp.classList.contains('hidden')) {
        console.warn('[Floating Ball] Header expansion is visible on load, hiding it');
        headerExp.classList.add('hidden');
      }

      if (askerExp && !askerExp.classList.contains('hidden')) {
        console.warn('[Floating Ball] Asker expansion is visible on load, hiding it');
        askerExp.classList.add('hidden');
      }

      console.log('[Floating Ball] Initialization complete');

      // 500ms 后启用 hover，避免初始化时误触发
      setTimeout(() => {
        isInitialized = true;
        console.log('[Floating Ball] Hover events enabled');

        // ========================================
        // 注册所有事件监听器
        // ========================================

        // Ball Zone 悬停 -> Header
        const ballZone = getBallZone();
        ballZone?.addEventListener('mouseenter', () => {
          console.log('[Floating Ball] Ball Zone mouseenter - currentState:', currentState);

          if (currentState !== 'ball') {
            console.log('[Floating Ball] Not expanding - already expanded');
            return;
          }

          console.log('[Floating Ball] Starting hover timer (200ms)...');
          hoverTimer = window.setTimeout(() => {
            console.log('[Floating Ball] Hover timer triggered, switching to header');
            switchTo('header');
          }, 200);
        });

        ballZone?.addEventListener('mouseleave', () => {
          if (hoverTimer) {
            clearTimeout(hoverTimer);
            hoverTimer = null;
          }

          // 鼠标离开 Ball Zone，300ms 后折叠（如果已展开）
          if (currentState !== 'ball') {
            hoverTimer = window.setTimeout(() => {
              switchTo('ball');
            }, 300);
          }
        });

        // Expansion Zone 鼠标事件
        const expansionZone = getExpansionZone();

        expansionZone?.addEventListener('mouseenter', () => {
          // 鼠标进入 Expansion Zone，取消折叠计时器
          if (hoverTimer) {
            clearTimeout(hoverTimer);
            hoverTimer = null;
          }
        });

        expansionZone?.addEventListener('mouseleave', () => {
          // 鼠标离开 Expansion Zone，300ms 后折叠
          hoverTimer = window.setTimeout(() => {
            if (currentState === 'header') {
              switchTo('ball');
            }
          }, 300);
        });

        // 点击 Ball -> Asker
        document.getElementById('floating-ball')?.addEventListener('click', (e) => {
          e.stopPropagation();
          switchTo('asker');
        });

        // 点击外部 -> Ball
        document.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const expZone = getExpansionZone();
          const bZone = getBallZone();

          // 如果点击的不在 ball zone 或 expansion zone 内，则折叠
          if (!expZone?.contains(target) && !bZone?.contains(target)) {
            if (currentState !== 'ball') {
              switchTo('ball');
            }
          }
        });

        // 键盘事件: ESC 折叠
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            if (currentState !== 'ball') {
              switchTo('ball');
            }
          }
        });

        // Memory 按钮
        document.getElementById('memory-btn')?.addEventListener('click', async () => {
          try {
            await invoke('open_memory_window');
          } catch (error) {
            console.error('Failed to open memory window:', error);
          }
        });

        // Popup 按钮（暂时保留，后续改为 Settings）
        document.getElementById('popup-btn')?.addEventListener('click', async () => {
          try {
            await invoke('open_popup_setting_window');
          } catch (error) {
            console.error('Failed to open popup-setting window:', error);
          }
        });

        // 关闭 Asker
        document.getElementById('close-asker')?.addEventListener('click', () => {
          switchTo('ball');
        });

        // ========================================
        // Memory Toggle (Header)
        // ========================================

        const memoryToggle = document.querySelector('.memory-toggle') as HTMLElement | null;
        let isMemoryEnabled = true;

        function updateHeaderToggleUI(enabled: boolean) {
          isMemoryEnabled = enabled;
          if (!memoryToggle) return;
          const ball = memoryToggle.querySelector('div') as HTMLElement;

          if (enabled) {
            memoryToggle.classList.remove('bg-secondary');
            memoryToggle.classList.add('gradient-success', 'justify-end');
          } else {
            memoryToggle.classList.remove('gradient-success', 'justify-end');
            memoryToggle.classList.add('bg-secondary');
          }
        }

        memoryToggle?.addEventListener('click', async () => {
          const oldState = isMemoryEnabled;
          const newState = !oldState;
          try {
            updateHeaderToggleUI(newState);
            await toggleMemory(newState);
          } catch (error) {
            updateHeaderToggleUI(oldState);
            console.error('Failed to toggle memory:', error);
          }
        });

        // 加载设置并同步 toggle 初始状态
        loadSettings().then(() => {
          const settings = $settings.get();
          if (settings) {
            updateHeaderToggleUI(settings.memory_enabled);
          }
        });

        // 订阅 settings 变化，保持 Header toggle 与 memory 页面同步
        $settings.subscribe((settings) => {
          if (settings) {
            updateHeaderToggleUI(settings.memory_enabled);
          }
        });

        console.log('[Floating Ball] All event listeners registered');
      }, 500);
    });
  </script>

  <style is:global>
    /* ========================================
     * 垂直布局样式 - Ball 在上，Expansion 在下
     * ======================================== */

    /* 确保 body 不会溢出 */
    body {
      width: 100%;
      max-width: 100vw;
      box-sizing: border-box;
    }

    /* Ball Zone - 宽度自适应窗口，Ball 靠右对齐 */
    #ball-zone {
      width: 100%;
      height: 64px;
      display: flex;
      align-items: center;
      justify-content: flex-end; /* Ball 始终靠右，避免瞬移 */
      /* 移除所有边框和背景 */
      border: none;
      outline: none;
      background: transparent;
    }

    /* Expansion Zone - 在 Ball 下方 */
    #expansion-zone {
      margin-top: 10px; /* 10px gap between ball and expansion */
      width: 100%;
    }

    /* Header Expansion */
    #header-expansion {
      width: 360px;
      height: 72px;
    }

    /* Asker Expansion */
    #asker-expansion {
      width: 360px;
      height: 480px;
    }

    /* 隐藏状态 */
    .hidden {
      display: none !important;
    }

    /* 过渡动画 */
    .transitioning-out {
      opacity: 0;
      transform: scale(0.95);
      transition: opacity 150ms ease-out, transform 150ms ease-out;
    }

    .transitioning-in {
      opacity: 0;
      transform: scale(1.05);
      animation: fadeIn 150ms ease-out forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* ========================================
     * 自定义滚动条
     * ======================================== */
    .custom-scrollbar::-webkit-scrollbar {
      width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: transparent;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</body>
</html>
