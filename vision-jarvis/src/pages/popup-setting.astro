---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="min-h-screen bg-app p-12">
    <div class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="mb-12">
        <h1 class="text-4xl font-bold text-primary mb-2">设置</h1>
        <p class="text-lg text-muted">配置您的应用偏好</p>
      </div>

      <!-- Tabs -->
      <div class="flex gap-4 mb-8 border-b border-primary">
        <button
          id="tab-general"
          class="tab-btn px-6 py-3 text-sm font-medium transition-colors border-b-2 border-transparent"
          data-tab="general"
        >
          通用设置
        </button>
        <button
          id="tab-ai"
          class="tab-btn px-6 py-3 text-sm font-medium transition-colors border-b-2 border-transparent"
          data-tab="ai"
        >
          AI 配置
        </button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content">
        <!-- General Settings Tab -->
        <div id="content-general" class="tab-content">
          <div class="grid gap-6">
            <!-- Card 1: 启动设置 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">启动设置</h2>
                  <p class="text-sm text-muted">应用启动时的行为配置</p>
                </div>
              </div>

              <div class="space-y-4">
                <!-- Auto Start -->
                <div class="flex items-center justify-between p-4 bg-input rounded-xl">
                  <span class="text-sm text-secondary">开机自动启动</span>
                  <div id="toggle-auto-start" class="w-12 h-6 bg-secondary rounded-full flex items-center px-0.5 cursor-pointer transition-all duration-300">
                    <div class="w-5 h-5 bg-white rounded-full transition-all duration-300 pointer-events-none"></div>
                  </div>
                </div>

                <!-- Startup Message -->
                <div>
                  <label class="text-sm text-secondary block mb-2">启动提醒文本</label>
                  <textarea
                    id="launch-text"
                    class="w-full h-24 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="输入启动提醒文本..."
                  ></textarea>
                  <button
                    id="save-launch-text"
                    class="mt-2 px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                  >
                    保存文本
                  </button>
                </div>
              </div>
            </div>

            <!-- Card 2: 早安提醒 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">早安提醒</h2>
                  <p class="text-sm text-muted">每天定时发送一条激励消息</p>
                </div>
                <div id="toggle-morning-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300 pointer-events-none"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-2">触发时间</label>
                  <input
                    id="morning-reminder-time"
                    type="time"
                    class="w-48 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                  />
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">提醒消息</label>
                  <textarea
                    id="morning-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="输入早安提醒消息..."
                  ></textarea>
                </div>
                <button
                  id="save-morning-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  保存
                </button>
              </div>
            </div>

            <!-- Card 3: 喝水提醒 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">喝水提醒</h2>
                  <p class="text-sm text-muted">在工作时间段内定期提醒喝水</p>
                </div>
                <div id="toggle-water-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300 pointer-events-none"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-3">提醒时间段</label>
                  <div class="flex items-center gap-4">
                    <input
                      id="water-reminder-start"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                    <span class="text-muted">至</span>
                    <input
                      id="water-reminder-end"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">提醒间隔</span>
                    <span class="text-info" id="water-interval-display">每 60 分钟</span>
                  </div>
                  <input
                    id="water-reminder-interval"
                    type="range"
                    min="15"
                    max="180"
                    value="60"
                    step="15"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>15分钟</span>
                    <span>180分钟</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">提醒消息</label>
                  <textarea
                    id="water-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="输入喝水提醒消息..."
                  ></textarea>
                </div>
                <button
                  id="save-water-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  保存
                </button>
              </div>
            </div>

            <!-- Card 4: 久坐提醒 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">久坐提醒</h2>
                  <p class="text-sm text-muted">连续工作超过阈值时提醒休息</p>
                </div>
                <div id="toggle-sedentary-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300 pointer-events-none"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-3">生效时间段</label>
                  <div class="flex items-center gap-4">
                    <input
                      id="sedentary-reminder-start"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                    <span class="text-muted">至</span>
                    <input
                      id="sedentary-reminder-end"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">久坐阈值</span>
                    <span class="text-info" id="sedentary-threshold-display">60 分钟</span>
                  </div>
                  <input
                    id="sedentary-threshold"
                    type="range"
                    min="15"
                    max="180"
                    value="60"
                    step="15"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>15分钟</span>
                    <span>180分钟</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">提醒消息</label>
                  <textarea
                    id="sedentary-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="输入久坐提醒消息..."
                  ></textarea>
                </div>
                <button
                  id="save-sedentary-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  保存
                </button>
              </div>
            </div>

            <!-- Card 5: 屏幕无变化提醒 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">屏幕无变化提醒</h2>
                  <p class="text-sm text-muted">检测屏幕长时间无变化时提醒</p>
                </div>
                <div id="toggle-screen-inactivity" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300 pointer-events-none"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">无变化阈值</span>
                    <span class="text-info" id="screen-inactivity-display">10 分钟</span>
                  </div>
                  <input
                    id="screen-inactivity-minutes"
                    type="range"
                    min="5"
                    max="60"
                    value="10"
                    step="5"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>5分钟</span>
                    <span>60分钟</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">提醒消息</label>
                  <textarea
                    id="screen-inactivity-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="留空则使用 AI 智能建议..."
                  ></textarea>
                </div>
                <button
                  id="save-screen-inactivity"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  保存
                </button>
              </div>
            </div>

            <!-- Card 6: 存储设置 -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">存储设置</h2>
                  <p class="text-sm text-muted">管理截图存储位置和容量</p>
                </div>
              </div>

              <div class="space-y-4">
                <!-- Storage Path -->
                <div>
                  <label class="text-sm text-secondary block mb-2">存储路径</label>
                  <div class="flex gap-2">
                    <input
                      id="storage-path"
                      type="text"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                      placeholder="~/Library/Application Support/vision-jarvis/screenshots"
                      readonly
                    />
                    <button
                      id="open-storage-folder"
                      class="px-4 py-2 bg-input rounded-xl border border-secondary hover:border-glow transition-colors text-sm text-primary"
                    >
                      打开
                    </button>
                  </div>
                </div>

                <!-- Storage Limit -->
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">存储容量限制</span>
                    <span class="text-info" id="storage-limit-display">1024 MB</span>
                  </div>
                  <input
                    id="storage-limit"
                    type="range"
                    min="512"
                    max="10240"
                    value="1024"
                    step="512"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>512MB</span>
                    <span>10GB</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Configuration Tab -->
        <div id="content-ai" class="tab-content hidden">
          <div class="grid gap-6">
            <!-- Provider Config Card -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <h2 class="text-2xl font-semibold text-primary mb-6">AI 提供商配置</h2>

              <!-- Provider Type Selection (三选一) -->
              <div class="flex gap-3 mb-6">
                <button data-provider="openai" class="provider-tab flex-1 py-3 rounded-xl border border-secondary bg-input text-sm font-medium text-muted hover:border-glow transition-colors">
                  OpenAI
                </button>
                <button data-provider="claude" class="provider-tab flex-1 py-3 rounded-xl border border-secondary bg-input text-sm font-medium text-muted hover:border-glow transition-colors">
                  Claude
                </button>
                <button data-provider="custom" class="provider-tab flex-1 py-3 rounded-xl border border-secondary bg-input text-sm font-medium text-muted hover:border-glow transition-colors">
                  三方供应商
                </button>
              </div>

              <!-- OpenAI Form -->
              <div id="provider-form-openai" class="provider-form hidden space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-2">API Key</label>
                  <input
                    id="openai-key"
                    type="password"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="sk-..."
                  />
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">模型</label>
                  <select
                    id="openai-model"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                  >
                    <option value="gpt-4o">GPT-4o</option>
                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    <option value="gpt-4">GPT-4</option>
                    <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                  </select>
                </div>
              </div>

              <!-- Claude Form -->
              <div id="provider-form-claude" class="provider-form hidden space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-2">API Key</label>
                  <input
                    id="claude-key"
                    type="password"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="sk-ant-..."
                  />
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">模型</label>
                  <select
                    id="claude-model"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                  >
                    <option value="claude-sonnet-4-5-20250514">Claude Sonnet 4.5</option>
                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                  </select>
                </div>
              </div>

              <!-- Custom Form -->
              <div id="provider-form-custom" class="provider-form hidden space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-2">API 地址</label>
                  <input
                    id="custom-url"
                    type="text"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="https://api.example.com"
                  />
                  <p class="text-xs text-muted mt-1">OpenAI 兼容格式，会自动添加 /v1/chat/completions</p>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">API Key</label>
                  <input
                    id="custom-key"
                    type="password"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="sk-..."
                  />
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">模型名称</label>
                  <input
                    id="custom-model"
                    type="text"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="输入模型名称"
                  />
                </div>
              </div>

              <!-- Action Buttons -->
              <div id="provider-actions" class="hidden flex gap-2 pt-4">
                <button
                  id="btn-save-provider"
                  class="flex-1 py-3 gradient-primary rounded-xl text-white font-medium text-sm hover:opacity-90 transition-opacity"
                >
                  保存配置
                </button>
                <button
                  id="btn-test-provider"
                  class="py-3 px-6 bg-input rounded-xl text-white font-medium text-sm hover:bg-secondary transition-colors"
                >
                  测试连接
                </button>
              </div>
            </div>

            <!-- Current Status -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <h2 class="text-2xl font-semibold text-primary mb-4">当前状态</h2>
              <div id="ai-status" class="text-sm text-muted">
                <p>加载中...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import {
      $settings,
      loadSettings,
      toggleAutoStart,
      updateLaunchText,
      toggleMorningReminder,
      toggleWaterReminder,
      toggleSedentaryReminder,
      toggleScreenInactivityReminder,
      updateSettings,
    } from '../stores/settingsStore'
    import { TauriAPI } from '../lib/tauri-api'
    import type { AIConfig, AIProviderConfig } from '../lib/tauri-api'

    // ========================================================================
    // Tab 切换
    // ========================================================================

    const tabs = document.querySelectorAll('.tab-btn')
    const tabContents = document.querySelectorAll('.tab-content')

    function switchTab(tabName: string) {
      // 更新 tab 按钮样式
      tabs.forEach((tab) => {
        const btn = tab as HTMLElement
        if (btn.dataset.tab === tabName) {
          btn.classList.add('border-info', 'text-info')
          btn.classList.remove('text-muted')
        } else {
          btn.classList.remove('border-info', 'text-info')
          btn.classList.add('text-muted')
        }
      })

      // 显示对应内容
      tabContents.forEach((content) => {
        const div = content as HTMLElement
        if (div.id === `content-${tabName}`) {
          div.classList.remove('hidden')
        } else {
          div.classList.add('hidden')
        }
      })
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const tabName = (tab as HTMLElement).dataset.tab
        if (tabName) {
          switchTab(tabName)
        }
      })
    })

    // 默认显示第一个 tab
    switchTab('general')

    // ========================================================================
    // 初始化
    // ========================================================================

    let isInitialized = false

    async function init() {
      if (isInitialized) return
      isInitialized = true

      try {
        await loadSettings()

        $settings.subscribe((settings) => {
          if (!settings) return

          // 更新通用设置 UI
          updateGeneralSettingsUI(settings)
        })

        // 加载 AI 配置
        await loadAIConfig()
      } catch (error) {
        console.error('Failed to initialize settings page:', error)
        showNotification('加载设置失败: ' + error, 'error')
      }
    }

    // ========================================================================
    // 通用设置 UI 更新
    // ========================================================================

    function updateGeneralSettingsUI(settings: any) {
      // 开机自启
      updateToggleUI('toggle-auto-start', settings.auto_start)

      // 启动文本
      const launchTextEl = document.getElementById('launch-text') as HTMLTextAreaElement
      if (launchTextEl) {
        launchTextEl.value = settings.app_launch_text || ''
      }

      // 早安提醒
      updateToggleUI('toggle-morning-reminder', settings.morning_reminder_enabled)
      const morningTimeEl = document.getElementById('morning-reminder-time') as HTMLInputElement
      const morningMsgEl = document.getElementById('morning-reminder-message') as HTMLTextAreaElement
      if (morningTimeEl) morningTimeEl.value = settings.morning_reminder_time || '08:00'
      if (morningMsgEl) morningMsgEl.value = settings.morning_reminder_message || ''

      // 喝水提醒
      updateToggleUI('toggle-water-reminder', settings.water_reminder_enabled)
      const waterStartEl = document.getElementById('water-reminder-start') as HTMLInputElement
      const waterEndEl = document.getElementById('water-reminder-end') as HTMLInputElement
      if (waterStartEl) waterStartEl.value = settings.water_reminder_start || '09:00'
      if (waterEndEl) waterEndEl.value = settings.water_reminder_end || '21:00'

      const waterIntervalEl = document.getElementById('water-reminder-interval') as HTMLInputElement
      const waterIntervalDisplayEl = document.getElementById('water-interval-display')
      if (waterIntervalEl) {
        waterIntervalEl.value = String(settings.water_reminder_interval_minutes || 60)
      }
      if (waterIntervalDisplayEl) {
        waterIntervalDisplayEl.textContent = `每 ${settings.water_reminder_interval_minutes || 60} 分钟`
      }

      const waterMsgEl = document.getElementById('water-reminder-message') as HTMLTextAreaElement
      if (waterMsgEl) waterMsgEl.value = settings.water_reminder_message || ''

      // 久坐提醒
      updateToggleUI('toggle-sedentary-reminder', settings.sedentary_reminder_enabled)
      const sedStartEl = document.getElementById('sedentary-reminder-start') as HTMLInputElement
      const sedEndEl = document.getElementById('sedentary-reminder-end') as HTMLInputElement
      if (sedStartEl) sedStartEl.value = settings.sedentary_reminder_start || '09:00'
      if (sedEndEl) sedEndEl.value = settings.sedentary_reminder_end || '21:00'

      const sedThresholdEl = document.getElementById('sedentary-threshold') as HTMLInputElement
      const sedThresholdDisplayEl = document.getElementById('sedentary-threshold-display')
      if (sedThresholdEl) {
        sedThresholdEl.value = String(settings.sedentary_reminder_threshold_minutes || 60)
      }
      if (sedThresholdDisplayEl) {
        sedThresholdDisplayEl.textContent = `${settings.sedentary_reminder_threshold_minutes || 60} 分钟`
      }

      const sedMsgEl = document.getElementById('sedentary-reminder-message') as HTMLTextAreaElement
      if (sedMsgEl) sedMsgEl.value = settings.sedentary_reminder_message || ''

      // 屏幕无变化提醒
      updateToggleUI('toggle-screen-inactivity', settings.screen_inactivity_reminder_enabled)
      const screenMinutesEl = document.getElementById('screen-inactivity-minutes') as HTMLInputElement
      const screenMinutesDisplayEl = document.getElementById('screen-inactivity-display')
      if (screenMinutesEl) {
        screenMinutesEl.value = String(settings.screen_inactivity_minutes || 10)
      }
      if (screenMinutesDisplayEl) {
        screenMinutesDisplayEl.textContent = `${settings.screen_inactivity_minutes || 10} 分钟`
      }

      const screenMsgEl = document.getElementById('screen-inactivity-message') as HTMLTextAreaElement
      if (screenMsgEl) screenMsgEl.value = settings.screen_inactivity_message || ''

      // 存储设置
      const storagePathEl = document.getElementById('storage-path') as HTMLInputElement
      if (storagePathEl) {
        storagePathEl.value = settings.storage_path || ''
      }

      const storageLimitEl = document.getElementById('storage-limit') as HTMLInputElement
      const storageLimitDisplayEl = document.getElementById('storage-limit-display')
      if (storageLimitEl) {
        storageLimitEl.value = String(settings.storage_limit_mb || 1024)
      }
      if (storageLimitDisplayEl) {
        storageLimitDisplayEl.textContent = `${settings.storage_limit_mb || 1024} MB`
      }
    }

    function updateToggleUI(toggleId: string, enabled: boolean) {
      const toggle = document.getElementById(toggleId)
      if (!toggle) return

      const ball = toggle.querySelector('div') as HTMLElement

      if (enabled) {
        toggle.classList.remove('bg-secondary')
        toggle.classList.add('gradient-success', 'justify-end')
      } else {
        toggle.classList.remove('gradient-success', 'justify-end')
        toggle.classList.add('bg-secondary')
      }
    }

    // ========================================================================
    // 通用设置事件绑定
    // ========================================================================

    // 开机自启
    document.getElementById('toggle-auto-start')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.auto_start
      try {
        updateToggleUI('toggle-auto-start', newState)
        await toggleAutoStart(newState)
        showNotification(newState ? '已启用开机自启' : '已禁用开机自启', 'success')
      } catch (error) {
        updateToggleUI('toggle-auto-start', settings.auto_start)
        showNotification('切换失败: ' + error, 'error')
      }
    })

    // 保存启动文本
    document.getElementById('save-launch-text')?.addEventListener('click', async () => {
      const launchTextEl = document.getElementById('launch-text') as HTMLTextAreaElement
      if (!launchTextEl) return

      try {
        await updateLaunchText(launchTextEl.value)
        showNotification('启动文本已保存', 'success')
      } catch (error) {
        showNotification('保存失败: ' + error, 'error')
      }
    })

    // ========== 早安提醒 ==========

    document.getElementById('toggle-morning-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.morning_reminder_enabled
      try {
        updateToggleUI('toggle-morning-reminder', newState)
        await toggleMorningReminder(newState)
        showNotification(newState ? '已启用早安提醒' : '已禁用早安提醒', 'success')
      } catch (error) {
        updateToggleUI('toggle-morning-reminder', settings.morning_reminder_enabled)
        showNotification('切换失败: ' + error, 'error')
      }
    })

    document.getElementById('save-morning-reminder')?.addEventListener('click', async () => {
      const timeEl = document.getElementById('morning-reminder-time') as HTMLInputElement
      const msgEl = document.getElementById('morning-reminder-message') as HTMLTextAreaElement
      if (!timeEl || !msgEl) return

      try {
        await updateSettings({
          morning_reminder_time: timeEl.value,
          morning_reminder_message: msgEl.value,
        })
        showNotification('早安提醒已保存', 'success')
      } catch (error) {
        showNotification('保存失败: ' + error, 'error')
      }
    })

    // ========== 喝水提醒 ==========

    document.getElementById('toggle-water-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.water_reminder_enabled
      try {
        updateToggleUI('toggle-water-reminder', newState)
        await toggleWaterReminder(newState)
        showNotification(newState ? '已启用喝水提醒' : '已禁用喝水提醒', 'success')
      } catch (error) {
        updateToggleUI('toggle-water-reminder', settings.water_reminder_enabled)
        showNotification('切换失败: ' + error, 'error')
      }
    })

    let waterIntervalTimer: number | null = null
    document.getElementById('water-reminder-interval')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('water-interval-display')
      if (displayEl) {
        displayEl.textContent = `每 ${value} 分钟`
      }

      if (waterIntervalTimer !== null) {
        clearTimeout(waterIntervalTimer)
      }

      waterIntervalTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ water_reminder_interval_minutes: value })
          showNotification(`喝水间隔已更新为 ${value} 分钟`, 'success')
        } catch (error) {
          showNotification('更新失败: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-water-reminder')?.addEventListener('click', async () => {
      const startEl = document.getElementById('water-reminder-start') as HTMLInputElement
      const endEl = document.getElementById('water-reminder-end') as HTMLInputElement
      const msgEl = document.getElementById('water-reminder-message') as HTMLTextAreaElement
      if (!startEl || !endEl || !msgEl) return

      try {
        await updateSettings({
          water_reminder_start: startEl.value,
          water_reminder_end: endEl.value,
          water_reminder_message: msgEl.value,
        })
        showNotification('喝水提醒已保存', 'success')
      } catch (error) {
        showNotification('保存失败: ' + error, 'error')
      }
    })

    // ========== 久坐提醒 ==========

    document.getElementById('toggle-sedentary-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.sedentary_reminder_enabled
      try {
        updateToggleUI('toggle-sedentary-reminder', newState)
        await toggleSedentaryReminder(newState)
        showNotification(newState ? '已启用久坐提醒' : '已禁用久坐提醒', 'success')
      } catch (error) {
        updateToggleUI('toggle-sedentary-reminder', settings.sedentary_reminder_enabled)
        showNotification('切换失败: ' + error, 'error')
      }
    })

    let sedentaryThresholdTimer: number | null = null
    document.getElementById('sedentary-threshold')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('sedentary-threshold-display')
      if (displayEl) {
        displayEl.textContent = `${value} 分钟`
      }

      if (sedentaryThresholdTimer !== null) {
        clearTimeout(sedentaryThresholdTimer)
      }

      sedentaryThresholdTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ sedentary_reminder_threshold_minutes: value })
          showNotification(`久坐阈值已更新为 ${value} 分钟`, 'success')
        } catch (error) {
          showNotification('更新失败: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-sedentary-reminder')?.addEventListener('click', async () => {
      const startEl = document.getElementById('sedentary-reminder-start') as HTMLInputElement
      const endEl = document.getElementById('sedentary-reminder-end') as HTMLInputElement
      const msgEl = document.getElementById('sedentary-reminder-message') as HTMLTextAreaElement
      if (!startEl || !endEl || !msgEl) return

      try {
        await updateSettings({
          sedentary_reminder_start: startEl.value,
          sedentary_reminder_end: endEl.value,
          sedentary_reminder_message: msgEl.value,
        })
        showNotification('久坐提醒已保存', 'success')
      } catch (error) {
        showNotification('保存失败: ' + error, 'error')
      }
    })

    // ========== 屏幕无变化提醒 ==========

    document.getElementById('toggle-screen-inactivity')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.screen_inactivity_reminder_enabled
      try {
        updateToggleUI('toggle-screen-inactivity', newState)
        await toggleScreenInactivityReminder(newState)
        showNotification(newState ? '已启用屏幕无变化提醒' : '已禁用屏幕无变化提醒', 'success')
      } catch (error) {
        updateToggleUI('toggle-screen-inactivity', settings.screen_inactivity_reminder_enabled)
        showNotification('切换失败: ' + error, 'error')
      }
    })

    let screenInactivityTimer: number | null = null
    document.getElementById('screen-inactivity-minutes')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('screen-inactivity-display')
      if (displayEl) {
        displayEl.textContent = `${value} 分钟`
      }

      if (screenInactivityTimer !== null) {
        clearTimeout(screenInactivityTimer)
      }

      screenInactivityTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ screen_inactivity_minutes: value })
          showNotification(`无变化阈值已更新为 ${value} 分钟`, 'success')
        } catch (error) {
          showNotification('更新失败: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-screen-inactivity')?.addEventListener('click', async () => {
      const msgEl = document.getElementById('screen-inactivity-message') as HTMLTextAreaElement
      if (!msgEl) return

      try {
        await updateSettings({ screen_inactivity_message: msgEl.value })
        showNotification('屏幕无变化提醒已保存', 'success')
      } catch (error) {
        showNotification('保存失败: ' + error, 'error')
      }
    })

    // 打开存储文件夹
    document.getElementById('open-storage-folder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      try {
        await TauriAPI.openFolder(settings.storage_path)
      } catch (error) {
        showNotification('打开文件夹失败: ' + error, 'error')
      }
    })

    // 存储容量限制滑块
    let storageLimitTimer: number | null = null
    document.getElementById('storage-limit')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('storage-limit-display')
      if (displayEl) {
        displayEl.textContent = `${value} MB`
      }

      if (storageLimitTimer !== null) {
        clearTimeout(storageLimitTimer)
      }

      storageLimitTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ storage_limit_mb: value })
          showNotification(`存储容量限制已更新为 ${value} MB`, 'success')
        } catch (error) {
          showNotification('更新失败: ' + error, 'error')
        }
      }, 500)
    })

    // ========================================================================
    // AI 配置
    // ========================================================================

    let selectedProviderType: string | null = null

    const PROVIDER_DEFAULTS: Record<string, { name: string; api_base_url: string; id: string }> = {
      openai: { name: 'OpenAI', api_base_url: 'https://api.openai.com', id: 'openai' },
      claude: { name: 'Claude', api_base_url: 'https://api.anthropic.com', id: 'claude' },
      custom: { name: 'Custom', api_base_url: '', id: 'custom' },
    }

    async function loadAIConfig() {
      try {
        const config = await TauriAPI.getAIConfig()
        updateAIStatus(config)

        // Pre-fill forms from existing providers
        config.providers.forEach((provider) => {
          if (provider.id === 'openai' || provider.name === 'OpenAI') {
            const keyEl = document.getElementById('openai-key') as HTMLInputElement
            const modelEl = document.getElementById('openai-model') as HTMLSelectElement
            if (keyEl) keyEl.value = provider.api_key
            if (modelEl) modelEl.value = provider.model
          } else if (provider.id === 'claude' || provider.name === 'Claude') {
            const keyEl = document.getElementById('claude-key') as HTMLInputElement
            const modelEl = document.getElementById('claude-model') as HTMLSelectElement
            if (keyEl) keyEl.value = provider.api_key
            if (modelEl) modelEl.value = provider.model
          } else {
            const urlEl = document.getElementById('custom-url') as HTMLInputElement
            const keyEl = document.getElementById('custom-key') as HTMLInputElement
            const modelEl = document.getElementById('custom-model') as HTMLInputElement
            if (urlEl) urlEl.value = provider.api_base_url
            if (keyEl) keyEl.value = provider.api_key
            if (modelEl) modelEl.value = provider.model
          }
        })

        // Highlight the active provider tab
        if (config.active_provider_id) {
          const activeProvider = config.providers.find(
            (p) => p.id === config.active_provider_id
          )
          if (activeProvider) {
            let type = 'custom'
            if (activeProvider.id === 'openai' || activeProvider.name === 'OpenAI') type = 'openai'
            else if (activeProvider.id === 'claude' || activeProvider.name === 'Claude')
              type = 'claude'
            selectProviderType(type)
          }
        }
      } catch (error) {
        console.error('Failed to load AI config:', error)
      }
    }

    function selectProviderType(type: string) {
      selectedProviderType = type

      // Update tab styles
      document.querySelectorAll('.provider-tab').forEach((tab) => {
        const btn = tab as HTMLElement
        if (btn.dataset.provider === type) {
          btn.classList.remove('bg-input', 'text-muted', 'border-secondary')
          btn.classList.add('gradient-primary', 'text-white', 'border-transparent')
        } else {
          btn.classList.remove('gradient-primary', 'text-white', 'border-transparent')
          btn.classList.add('bg-input', 'text-muted', 'border-secondary')
        }
      })

      // Show/hide forms
      document.querySelectorAll('.provider-form').forEach((form) => {
        form.classList.add('hidden')
      })
      document.getElementById(`provider-form-${type}`)?.classList.remove('hidden')

      // Show action buttons
      document.getElementById('provider-actions')?.classList.remove('hidden')
    }

    // Provider tab click handlers
    document.querySelectorAll('.provider-tab').forEach((tab) => {
      tab.addEventListener('click', () => {
        const type = (tab as HTMLElement).dataset.provider
        if (type) selectProviderType(type)
      })
    })

    function getProviderFormData(): {
      name: string
      api_base_url: string
      api_key: string
      model: string
      id: string
    } | null {
      if (!selectedProviderType) {
        showNotification('请先选择一个提供商类型', 'error')
        return null
      }

      const defaults = PROVIDER_DEFAULTS[selectedProviderType]

      if (selectedProviderType === 'openai') {
        const key = (document.getElementById('openai-key') as HTMLInputElement).value.trim()
        const model = (document.getElementById('openai-model') as HTMLSelectElement).value
        if (!key) {
          showNotification('请输入 OpenAI API Key', 'error')
          return null
        }
        return { ...defaults, api_key: key, model }
      } else if (selectedProviderType === 'claude') {
        const key = (document.getElementById('claude-key') as HTMLInputElement).value.trim()
        const model = (document.getElementById('claude-model') as HTMLSelectElement).value
        if (!key) {
          showNotification('请输入 Claude API Key', 'error')
          return null
        }
        return { ...defaults, api_key: key, model }
      } else {
        const url = (document.getElementById('custom-url') as HTMLInputElement).value.trim()
        const key = (document.getElementById('custom-key') as HTMLInputElement).value.trim()
        const model = (document.getElementById('custom-model') as HTMLInputElement).value.trim()
        if (!url) {
          showNotification('请输入 API 地址', 'error')
          return null
        }
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
          showNotification('API 地址必须以 http:// 或 https:// 开头', 'error')
          return null
        }
        if (!key) {
          showNotification('请输入 API Key', 'error')
          return null
        }
        if (!model) {
          showNotification('请输入模型名称', 'error')
          return null
        }
        return { id: 'custom', name: 'Custom', api_base_url: url, api_key: key, model }
      }
    }

    // Save provider
    document.getElementById('btn-save-provider')?.addEventListener('click', async () => {
      const data = getProviderFormData()
      if (!data) return

      try {
        const providerConfig: AIProviderConfig = {
          id: data.id,
          name: data.name,
          api_base_url: data.api_base_url,
          api_key: data.api_key,
          model: data.model,
          enabled: true,
          is_active: true,
        }

        await TauriAPI.updateAIProviderConfig(providerConfig)
        await TauriAPI.setActiveAIProvider(data.id)
        showNotification(`已保存 ${data.name} 配置`, 'success')

        const config = await TauriAPI.getAIConfig()
        updateAIStatus(config)
      } catch (err) {
        showNotification('保存失败: ' + err, 'error')
      }
    })

    // Test provider
    document.getElementById('btn-test-provider')?.addEventListener('click', async () => {
      const data = getProviderFormData()
      if (!data) return

      try {
        showNotification('正在测试连接...', 'info')

        const providerConfig: AIProviderConfig = {
          id: data.id,
          name: data.name,
          api_base_url: data.api_base_url,
          api_key: data.api_key,
          model: data.model,
          enabled: true,
          is_active: false,
        }

        await TauriAPI.updateAIProviderConfig(providerConfig)
        const result = await TauriAPI.testAIConnection(data.id)
        showNotification('连接成功: ' + result, 'success')
      } catch (err) {
        showNotification('连接失败: ' + err, 'error')
      }
    })

    function updateAIStatus(config: AIConfig) {
      const container = document.getElementById('ai-status')
      if (!container) return

      if (config.providers.length === 0) {
        container.innerHTML =
          '<p class="text-muted">未配置任何 AI 提供商</p>' +
          '<p class="text-xs text-muted mt-1">在上方选择一个提供商并配置</p>'
        return
      }

      const activeProvider = config.providers.find((p) => p.id === config.active_provider_id)
      if (activeProvider) {
        const maskedKey =
          activeProvider.api_key.length > 8
            ? activeProvider.api_key.slice(0, 4) + '****' + activeProvider.api_key.slice(-4)
            : '****'

        container.innerHTML = `
          <div class="flex items-center gap-2 mb-2">
            <div class="w-2 h-2 rounded-full bg-green-400"></div>
            <span class="text-primary font-medium">${activeProvider.name}</span>
            <span class="text-xs text-success">[活跃]</span>
          </div>
          <div class="text-xs text-muted space-y-1">
            <p>模型: ${activeProvider.model}</p>
            <p>Key: ${maskedKey}</p>
            ${activeProvider.api_base_url ? `<p>API: ${activeProvider.api_base_url}</p>` : ''}
          </div>
        `
      } else {
        container.innerHTML = '<p class="text-muted">已配置提供商但未激活</p>'
      }
    }

    // ========================================================================
    // 通知
    // ========================================================================

    function showNotification(message: string, type: 'success' | 'error' | 'info') {
      const notification = document.createElement('div')
      notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-[12px] text-white font-medium z-50 transition-all
        ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`
      notification.textContent = message
      document.body.appendChild(notification)

      setTimeout(() => {
        notification.remove()
      }, 3000)
    }

    // ========================================================================
    // 启动
    // ========================================================================

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init)
    } else {
      init()
    }
  </script>
</Layout>
