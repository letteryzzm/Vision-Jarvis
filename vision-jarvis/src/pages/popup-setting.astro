---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="min-h-screen bg-app p-12">
    <div class="max-w-5xl mx-auto">
      <!-- Header -->
      <div class="mb-12">
        <h1 class="text-4xl font-bold text-primary mb-2">è®¾ç½®</h1>
        <p class="text-lg text-muted">é…ç½®æ‚¨çš„åº”ç”¨åå¥½</p>
      </div>

      <!-- Tabs -->
      <div class="flex gap-4 mb-8 border-b border-primary">
        <button
          id="tab-general"
          class="tab-btn px-6 py-3 text-sm font-medium transition-colors border-b-2 border-transparent"
          data-tab="general"
        >
          é€šç”¨è®¾ç½®
        </button>
        <button
          id="tab-ai"
          class="tab-btn px-6 py-3 text-sm font-medium transition-colors border-b-2 border-transparent"
          data-tab="ai"
        >
          AI é…ç½®
        </button>
      </div>

      <!-- Tab Content -->
      <div id="tab-content">
        <!-- General Settings Tab -->
        <div id="content-general" class="tab-content">
          <div class="grid gap-6">
            <!-- Card 1: å¯åŠ¨è®¾ç½® -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">å¯åŠ¨è®¾ç½®</h2>
                  <p class="text-sm text-muted">åº”ç”¨å¯åŠ¨æ—¶çš„è¡Œä¸ºé…ç½®</p>
                </div>
              </div>

              <div class="space-y-4">
                <!-- Auto Start -->
                <div class="flex items-center justify-between p-4 bg-input rounded-xl">
                  <span class="text-sm text-secondary">å¼€æœºè‡ªåŠ¨å¯åŠ¨</span>
                  <div id="toggle-auto-start" class="w-12 h-6 bg-secondary rounded-full flex items-center px-0.5 cursor-pointer transition-all duration-300">
                    <div class="w-5 h-5 bg-white rounded-full transition-all duration-300"></div>
                  </div>
                </div>

                <!-- Startup Message -->
                <div>
                  <label class="text-sm text-secondary block mb-2">å¯åŠ¨æé†’æ–‡æœ¬</label>
                  <textarea
                    id="launch-text"
                    class="w-full h-24 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="è¾“å…¥å¯åŠ¨æé†’æ–‡æœ¬..."
                  ></textarea>
                  <button
                    id="save-launch-text"
                    class="mt-2 px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                  >
                    ä¿å­˜æ–‡æœ¬
                  </button>
                </div>
              </div>
            </div>

            <!-- Card 2: æ—©å®‰æé†’ -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">æ—©å®‰æé†’</h2>
                  <p class="text-sm text-muted">æ¯å¤©å®šæ—¶å‘é€ä¸€æ¡æ¿€åŠ±æ¶ˆæ¯</p>
                </div>
                <div id="toggle-morning-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-2">è§¦å‘æ—¶é—´</label>
                  <input
                    id="morning-reminder-time"
                    type="time"
                    class="w-48 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                  />
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">æé†’æ¶ˆæ¯</label>
                  <textarea
                    id="morning-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="è¾“å…¥æ—©å®‰æé†’æ¶ˆæ¯..."
                  ></textarea>
                </div>
                <button
                  id="save-morning-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>

            <!-- Card 3: å–æ°´æé†’ -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">å–æ°´æé†’</h2>
                  <p class="text-sm text-muted">åœ¨å·¥ä½œæ—¶é—´æ®µå†…å®šæœŸæé†’å–æ°´</p>
                </div>
                <div id="toggle-water-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-3">æé†’æ—¶é—´æ®µ</label>
                  <div class="flex items-center gap-4">
                    <input
                      id="water-reminder-start"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                    <span class="text-muted">è‡³</span>
                    <input
                      id="water-reminder-end"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">æé†’é—´éš”</span>
                    <span class="text-info" id="water-interval-display">æ¯ 60 åˆ†é’Ÿ</span>
                  </div>
                  <input
                    id="water-reminder-interval"
                    type="range"
                    min="15"
                    max="180"
                    value="60"
                    step="15"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>15åˆ†é’Ÿ</span>
                    <span>180åˆ†é’Ÿ</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">æé†’æ¶ˆæ¯</label>
                  <textarea
                    id="water-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="è¾“å…¥å–æ°´æé†’æ¶ˆæ¯..."
                  ></textarea>
                </div>
                <button
                  id="save-water-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>

            <!-- Card 4: ä¹…åæé†’ -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">ä¹…åæé†’</h2>
                  <p class="text-sm text-muted">è¿ç»­å·¥ä½œè¶…è¿‡é˜ˆå€¼æ—¶æé†’ä¼‘æ¯</p>
                </div>
                <div id="toggle-sedentary-reminder" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <label class="text-sm text-secondary block mb-3">ç”Ÿæ•ˆæ—¶é—´æ®µ</label>
                  <div class="flex items-center gap-4">
                    <input
                      id="sedentary-reminder-start"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                    <span class="text-muted">è‡³</span>
                    <input
                      id="sedentary-reminder-end"
                      type="time"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    />
                  </div>
                </div>
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">ä¹…åé˜ˆå€¼</span>
                    <span class="text-info" id="sedentary-threshold-display">60 åˆ†é’Ÿ</span>
                  </div>
                  <input
                    id="sedentary-threshold"
                    type="range"
                    min="15"
                    max="180"
                    value="60"
                    step="15"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>15åˆ†é’Ÿ</span>
                    <span>180åˆ†é’Ÿ</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">æé†’æ¶ˆæ¯</label>
                  <textarea
                    id="sedentary-reminder-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="è¾“å…¥ä¹…åæé†’æ¶ˆæ¯..."
                  ></textarea>
                </div>
                <button
                  id="save-sedentary-reminder"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>

            <!-- Card 5: å±å¹•æ— å˜åŒ–æé†’ -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">å±å¹•æ— å˜åŒ–æé†’</h2>
                  <p class="text-sm text-muted">æ£€æµ‹å±å¹•é•¿æ—¶é—´æ— å˜åŒ–æ—¶æé†’</p>
                </div>
                <div id="toggle-screen-inactivity" class="w-16 h-8 bg-secondary rounded-full flex items-center px-1 cursor-pointer transition-all duration-300">
                  <div class="w-6 h-6 bg-white rounded-full transition-all duration-300"></div>
                </div>
              </div>

              <div class="space-y-4">
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">æ— å˜åŒ–é˜ˆå€¼</span>
                    <span class="text-info" id="screen-inactivity-display">10 åˆ†é’Ÿ</span>
                  </div>
                  <input
                    id="screen-inactivity-minutes"
                    type="range"
                    min="5"
                    max="60"
                    value="10"
                    step="5"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>5åˆ†é’Ÿ</span>
                    <span>60åˆ†é’Ÿ</span>
                  </div>
                </div>
                <div>
                  <label class="text-sm text-secondary block mb-2">æé†’æ¶ˆæ¯</label>
                  <textarea
                    id="screen-inactivity-message"
                    class="w-full h-20 p-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary resize-none"
                    placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ AI æ™ºèƒ½å»ºè®®..."
                  ></textarea>
                </div>
                <button
                  id="save-screen-inactivity"
                  class="px-4 py-2 bg-input rounded-lg border border-secondary hover:border-glow transition-colors text-sm text-primary"
                >
                  ä¿å­˜
                </button>
              </div>
            </div>

            <!-- Card 6: å­˜å‚¨è®¾ç½® -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <div class="flex items-start justify-between mb-6">
                <div>
                  <h2 class="text-2xl font-semibold text-primary mb-2">å­˜å‚¨è®¾ç½®</h2>
                  <p class="text-sm text-muted">ç®¡ç†æˆªå›¾å­˜å‚¨ä½ç½®å’Œå®¹é‡</p>
                </div>
              </div>

              <div class="space-y-4">
                <!-- Storage Path -->
                <div>
                  <label class="text-sm text-secondary block mb-2">å­˜å‚¨è·¯å¾„</label>
                  <div class="flex gap-2">
                    <input
                      id="storage-path"
                      type="text"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                      placeholder="~/Library/Application Support/vision-jarvis/screenshots"
                      readonly
                    />
                    <button
                      id="open-storage-folder"
                      class="px-4 py-2 bg-input rounded-xl border border-secondary hover:border-glow transition-colors text-sm text-primary"
                    >
                      æ‰“å¼€
                    </button>
                  </div>
                </div>

                <!-- Storage Limit -->
                <div>
                  <div class="flex justify-between text-sm mb-3">
                    <span class="text-secondary">å­˜å‚¨å®¹é‡é™åˆ¶</span>
                    <span class="text-info" id="storage-limit-display">1024 MB</span>
                  </div>
                  <input
                    id="storage-limit"
                    type="range"
                    min="512"
                    max="10240"
                    value="1024"
                    step="512"
                    class="w-full"
                  />
                  <div class="flex justify-between text-xs text-muted mt-1">
                    <span>512MB</span>
                    <span>10GB</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- AI Configuration Tab -->
        <div id="content-ai" class="tab-content hidden">
          <div class="grid gap-6">
            <!-- Add Provider Form -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <h2 class="text-2xl font-semibold text-primary mb-6">æ·»åŠ  AI æä¾›å•†</h2>

              <div class="space-y-4">
                <!-- Provider Name -->
                <div>
                  <label class="text-sm text-secondary block mb-2">æä¾›å•†åç§°</label>
                  <input
                    id="new-provider-name"
                    type="text"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    placeholder="ä¾‹å¦‚: AIHubMix"
                  />
                </div>

                <!-- API Base URL -->
                <div>
                  <label class="text-sm text-secondary block mb-2">API åœ°å€</label>
                  <input
                    id="new-provider-url"
                    type="text"
                    class="w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                    placeholder="https://api.aihubmix.com"
                  />
                  <p class="text-xs text-muted mt-1">OpenAI å…¼å®¹æ ¼å¼ï¼Œä¼šè‡ªåŠ¨æ·»åŠ  /v1/chat/completions</p>
                </div>

                <!-- Model Selection -->
                <div>
                  <label class="text-sm text-secondary block mb-2">æ¨¡å‹</label>
                  <div class="flex gap-2">
                    <select
                      id="new-provider-model-select"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary"
                    >
                      <option value="">é€‰æ‹©é¢„è®¾æ¨¡å‹...</option>
                      <!-- Will be populated dynamically -->
                    </select>
                    <button
                      id="toggle-custom-model"
                      class="px-4 py-2 bg-input rounded-xl border border-secondary hover:border-glow transition-colors text-sm text-primary"
                    >
                      è‡ªå®šä¹‰
                    </button>
                  </div>
                  <input
                    id="new-provider-model-custom"
                    type="text"
                    class="hidden w-full h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono mt-2"
                    placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°"
                  />
                </div>

                <!-- API Key -->
                <div>
                  <label class="text-sm text-secondary block mb-2">API Key</label>
                  <div class="flex gap-2">
                    <input
                      id="new-provider-key"
                      type="password"
                      class="flex-1 h-12 px-4 bg-input rounded-xl border border-secondary focus:border-glow outline-none text-sm text-primary font-mono"
                      placeholder="sk-..."
                    />
                    <button
                      id="toggle-key-visibility"
                      class="px-4 py-2 bg-input rounded-xl border border-secondary hover:border-glow transition-colors text-sm text-primary"
                    >
                      ğŸ‘ï¸
                    </button>
                  </div>
                  <p class="text-xs text-muted mt-1">API Key å°†åŠ å¯†å­˜å‚¨åœ¨æœ¬åœ°</p>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-2 pt-2">
                  <button
                    id="btn-add-provider"
                    class="flex-1 py-3 gradient-primary rounded-xl text-white font-medium text-sm hover:opacity-90 transition-opacity"
                  >
                    æ·»åŠ æä¾›å•†
                  </button>
                  <button
                    id="btn-test-new-provider"
                    class="py-3 px-6 bg-input rounded-xl text-white font-medium text-sm hover:bg-secondary transition-colors"
                  >
                    æµ‹è¯•è¿æ¥
                  </button>
                </div>
              </div>
            </div>

            <!-- Existing Providers List -->
            <div class="p-8 bg-card rounded-[24px] border border-primary">
              <h2 class="text-2xl font-semibold text-primary mb-6">å·²é…ç½®çš„æä¾›å•†</h2>
              <div id="ai-providers-list">
                <!-- Will be populated dynamically -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import {
      $settings,
      loadSettings,
      toggleAutoStart,
      updateLaunchText,
      toggleMorningReminder,
      toggleWaterReminder,
      toggleSedentaryReminder,
      toggleScreenInactivityReminder,
      updateSettings,
    } from '../stores/settingsStore'
    import { TauriAPI } from '../lib/tauri-api'
    import type { AIConfig, AIProviderConfig } from '../lib/tauri-api'

    // ========================================================================
    // Tab åˆ‡æ¢
    // ========================================================================

    const tabs = document.querySelectorAll('.tab-btn')
    const tabContents = document.querySelectorAll('.tab-content')

    function switchTab(tabName: string) {
      // æ›´æ–° tab æŒ‰é’®æ ·å¼
      tabs.forEach((tab) => {
        const btn = tab as HTMLElement
        if (btn.dataset.tab === tabName) {
          btn.classList.add('border-info', 'text-info')
          btn.classList.remove('text-muted')
        } else {
          btn.classList.remove('border-info', 'text-info')
          btn.classList.add('text-muted')
        }
      })

      // æ˜¾ç¤ºå¯¹åº”å†…å®¹
      tabContents.forEach((content) => {
        const div = content as HTMLElement
        if (div.id === `content-${tabName}`) {
          div.classList.remove('hidden')
        } else {
          div.classList.add('hidden')
        }
      })
    }

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const tabName = (tab as HTMLElement).dataset.tab
        if (tabName) {
          switchTab(tabName)
        }
      })
    })

    // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€ä¸ª tab
    switchTab('general')

    // ========================================================================
    // åˆå§‹åŒ–
    // ========================================================================

    let isInitialized = false

    async function init() {
      if (isInitialized) return
      isInitialized = true

      try {
        await loadSettings()

        $settings.subscribe((settings) => {
          if (!settings) return

          // æ›´æ–°é€šç”¨è®¾ç½® UI
          updateGeneralSettingsUI(settings)
        })

        // åŠ è½½ AI é…ç½®
        await loadAIConfig()
      } catch (error) {
        console.error('Failed to initialize settings page:', error)
        showNotification('åŠ è½½è®¾ç½®å¤±è´¥: ' + error, 'error')
      }
    }

    // ========================================================================
    // é€šç”¨è®¾ç½® UI æ›´æ–°
    // ========================================================================

    function updateGeneralSettingsUI(settings: any) {
      // å¼€æœºè‡ªå¯
      updateToggleUI('toggle-auto-start', settings.auto_start)

      // å¯åŠ¨æ–‡æœ¬
      const launchTextEl = document.getElementById('launch-text') as HTMLTextAreaElement
      if (launchTextEl) {
        launchTextEl.value = settings.app_launch_text || ''
      }

      // æ—©å®‰æé†’
      updateToggleUI('toggle-morning-reminder', settings.morning_reminder_enabled)
      const morningTimeEl = document.getElementById('morning-reminder-time') as HTMLInputElement
      const morningMsgEl = document.getElementById('morning-reminder-message') as HTMLTextAreaElement
      if (morningTimeEl) morningTimeEl.value = settings.morning_reminder_time || '08:00'
      if (morningMsgEl) morningMsgEl.value = settings.morning_reminder_message || ''

      // å–æ°´æé†’
      updateToggleUI('toggle-water-reminder', settings.water_reminder_enabled)
      const waterStartEl = document.getElementById('water-reminder-start') as HTMLInputElement
      const waterEndEl = document.getElementById('water-reminder-end') as HTMLInputElement
      if (waterStartEl) waterStartEl.value = settings.water_reminder_start || '09:00'
      if (waterEndEl) waterEndEl.value = settings.water_reminder_end || '21:00'

      const waterIntervalEl = document.getElementById('water-reminder-interval') as HTMLInputElement
      const waterIntervalDisplayEl = document.getElementById('water-interval-display')
      if (waterIntervalEl) {
        waterIntervalEl.value = String(settings.water_reminder_interval_minutes || 60)
      }
      if (waterIntervalDisplayEl) {
        waterIntervalDisplayEl.textContent = `æ¯ ${settings.water_reminder_interval_minutes || 60} åˆ†é’Ÿ`
      }

      const waterMsgEl = document.getElementById('water-reminder-message') as HTMLTextAreaElement
      if (waterMsgEl) waterMsgEl.value = settings.water_reminder_message || ''

      // ä¹…åæé†’
      updateToggleUI('toggle-sedentary-reminder', settings.sedentary_reminder_enabled)
      const sedStartEl = document.getElementById('sedentary-reminder-start') as HTMLInputElement
      const sedEndEl = document.getElementById('sedentary-reminder-end') as HTMLInputElement
      if (sedStartEl) sedStartEl.value = settings.sedentary_reminder_start || '09:00'
      if (sedEndEl) sedEndEl.value = settings.sedentary_reminder_end || '21:00'

      const sedThresholdEl = document.getElementById('sedentary-threshold') as HTMLInputElement
      const sedThresholdDisplayEl = document.getElementById('sedentary-threshold-display')
      if (sedThresholdEl) {
        sedThresholdEl.value = String(settings.sedentary_reminder_threshold_minutes || 60)
      }
      if (sedThresholdDisplayEl) {
        sedThresholdDisplayEl.textContent = `${settings.sedentary_reminder_threshold_minutes || 60} åˆ†é’Ÿ`
      }

      const sedMsgEl = document.getElementById('sedentary-reminder-message') as HTMLTextAreaElement
      if (sedMsgEl) sedMsgEl.value = settings.sedentary_reminder_message || ''

      // å±å¹•æ— å˜åŒ–æé†’
      updateToggleUI('toggle-screen-inactivity', settings.screen_inactivity_reminder_enabled)
      const screenMinutesEl = document.getElementById('screen-inactivity-minutes') as HTMLInputElement
      const screenMinutesDisplayEl = document.getElementById('screen-inactivity-display')
      if (screenMinutesEl) {
        screenMinutesEl.value = String(settings.screen_inactivity_minutes || 10)
      }
      if (screenMinutesDisplayEl) {
        screenMinutesDisplayEl.textContent = `${settings.screen_inactivity_minutes || 10} åˆ†é’Ÿ`
      }

      const screenMsgEl = document.getElementById('screen-inactivity-message') as HTMLTextAreaElement
      if (screenMsgEl) screenMsgEl.value = settings.screen_inactivity_message || ''

      // å­˜å‚¨è®¾ç½®
      const storagePathEl = document.getElementById('storage-path') as HTMLInputElement
      if (storagePathEl) {
        storagePathEl.value = settings.storage_path || ''
      }

      const storageLimitEl = document.getElementById('storage-limit') as HTMLInputElement
      const storageLimitDisplayEl = document.getElementById('storage-limit-display')
      if (storageLimitEl) {
        storageLimitEl.value = String(settings.storage_limit_mb || 1024)
      }
      if (storageLimitDisplayEl) {
        storageLimitDisplayEl.textContent = `${settings.storage_limit_mb || 1024} MB`
      }
    }

    function updateToggleUI(toggleId: string, enabled: boolean) {
      const toggle = document.getElementById(toggleId)
      if (!toggle) return

      const ball = toggle.querySelector('div') as HTMLElement

      if (enabled) {
        toggle.classList.remove('bg-secondary')
        toggle.classList.add('gradient-success', 'justify-end')
      } else {
        toggle.classList.remove('gradient-success', 'justify-end')
        toggle.classList.add('bg-secondary')
      }
    }

    // ========================================================================
    // é€šç”¨è®¾ç½®äº‹ä»¶ç»‘å®š
    // ========================================================================

    // å¼€æœºè‡ªå¯
    document.getElementById('toggle-auto-start')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.auto_start
      try {
        updateToggleUI('toggle-auto-start', newState)
        await toggleAutoStart(newState)
        showNotification(newState ? 'å·²å¯ç”¨å¼€æœºè‡ªå¯' : 'å·²ç¦ç”¨å¼€æœºè‡ªå¯', 'success')
      } catch (error) {
        updateToggleUI('toggle-auto-start', settings.auto_start)
        showNotification('åˆ‡æ¢å¤±è´¥: ' + error, 'error')
      }
    })

    // ä¿å­˜å¯åŠ¨æ–‡æœ¬
    document.getElementById('save-launch-text')?.addEventListener('click', async () => {
      const launchTextEl = document.getElementById('launch-text') as HTMLTextAreaElement
      if (!launchTextEl) return

      try {
        await updateLaunchText(launchTextEl.value)
        showNotification('å¯åŠ¨æ–‡æœ¬å·²ä¿å­˜', 'success')
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error, 'error')
      }
    })

    // ========== æ—©å®‰æé†’ ==========

    document.getElementById('toggle-morning-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.morning_reminder_enabled
      try {
        updateToggleUI('toggle-morning-reminder', newState)
        await toggleMorningReminder(newState)
        showNotification(newState ? 'å·²å¯ç”¨æ—©å®‰æé†’' : 'å·²ç¦ç”¨æ—©å®‰æé†’', 'success')
      } catch (error) {
        updateToggleUI('toggle-morning-reminder', settings.morning_reminder_enabled)
        showNotification('åˆ‡æ¢å¤±è´¥: ' + error, 'error')
      }
    })

    document.getElementById('save-morning-reminder')?.addEventListener('click', async () => {
      const timeEl = document.getElementById('morning-reminder-time') as HTMLInputElement
      const msgEl = document.getElementById('morning-reminder-message') as HTMLTextAreaElement
      if (!timeEl || !msgEl) return

      try {
        await updateSettings({
          morning_reminder_time: timeEl.value,
          morning_reminder_message: msgEl.value,
        })
        showNotification('æ—©å®‰æé†’å·²ä¿å­˜', 'success')
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error, 'error')
      }
    })

    // ========== å–æ°´æé†’ ==========

    document.getElementById('toggle-water-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.water_reminder_enabled
      try {
        updateToggleUI('toggle-water-reminder', newState)
        await toggleWaterReminder(newState)
        showNotification(newState ? 'å·²å¯ç”¨å–æ°´æé†’' : 'å·²ç¦ç”¨å–æ°´æé†’', 'success')
      } catch (error) {
        updateToggleUI('toggle-water-reminder', settings.water_reminder_enabled)
        showNotification('åˆ‡æ¢å¤±è´¥: ' + error, 'error')
      }
    })

    let waterIntervalTimer: number | null = null
    document.getElementById('water-reminder-interval')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('water-interval-display')
      if (displayEl) {
        displayEl.textContent = `æ¯ ${value} åˆ†é’Ÿ`
      }

      if (waterIntervalTimer !== null) {
        clearTimeout(waterIntervalTimer)
      }

      waterIntervalTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ water_reminder_interval_minutes: value })
          showNotification(`å–æ°´é—´éš”å·²æ›´æ–°ä¸º ${value} åˆ†é’Ÿ`, 'success')
        } catch (error) {
          showNotification('æ›´æ–°å¤±è´¥: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-water-reminder')?.addEventListener('click', async () => {
      const startEl = document.getElementById('water-reminder-start') as HTMLInputElement
      const endEl = document.getElementById('water-reminder-end') as HTMLInputElement
      const msgEl = document.getElementById('water-reminder-message') as HTMLTextAreaElement
      if (!startEl || !endEl || !msgEl) return

      try {
        await updateSettings({
          water_reminder_start: startEl.value,
          water_reminder_end: endEl.value,
          water_reminder_message: msgEl.value,
        })
        showNotification('å–æ°´æé†’å·²ä¿å­˜', 'success')
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error, 'error')
      }
    })

    // ========== ä¹…åæé†’ ==========

    document.getElementById('toggle-sedentary-reminder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.sedentary_reminder_enabled
      try {
        updateToggleUI('toggle-sedentary-reminder', newState)
        await toggleSedentaryReminder(newState)
        showNotification(newState ? 'å·²å¯ç”¨ä¹…åæé†’' : 'å·²ç¦ç”¨ä¹…åæé†’', 'success')
      } catch (error) {
        updateToggleUI('toggle-sedentary-reminder', settings.sedentary_reminder_enabled)
        showNotification('åˆ‡æ¢å¤±è´¥: ' + error, 'error')
      }
    })

    let sedentaryThresholdTimer: number | null = null
    document.getElementById('sedentary-threshold')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('sedentary-threshold-display')
      if (displayEl) {
        displayEl.textContent = `${value} åˆ†é’Ÿ`
      }

      if (sedentaryThresholdTimer !== null) {
        clearTimeout(sedentaryThresholdTimer)
      }

      sedentaryThresholdTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ sedentary_reminder_threshold_minutes: value })
          showNotification(`ä¹…åé˜ˆå€¼å·²æ›´æ–°ä¸º ${value} åˆ†é’Ÿ`, 'success')
        } catch (error) {
          showNotification('æ›´æ–°å¤±è´¥: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-sedentary-reminder')?.addEventListener('click', async () => {
      const startEl = document.getElementById('sedentary-reminder-start') as HTMLInputElement
      const endEl = document.getElementById('sedentary-reminder-end') as HTMLInputElement
      const msgEl = document.getElementById('sedentary-reminder-message') as HTMLTextAreaElement
      if (!startEl || !endEl || !msgEl) return

      try {
        await updateSettings({
          sedentary_reminder_start: startEl.value,
          sedentary_reminder_end: endEl.value,
          sedentary_reminder_message: msgEl.value,
        })
        showNotification('ä¹…åæé†’å·²ä¿å­˜', 'success')
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error, 'error')
      }
    })

    // ========== å±å¹•æ— å˜åŒ–æé†’ ==========

    document.getElementById('toggle-screen-inactivity')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      const newState = !settings.screen_inactivity_reminder_enabled
      try {
        updateToggleUI('toggle-screen-inactivity', newState)
        await toggleScreenInactivityReminder(newState)
        showNotification(newState ? 'å·²å¯ç”¨å±å¹•æ— å˜åŒ–æé†’' : 'å·²ç¦ç”¨å±å¹•æ— å˜åŒ–æé†’', 'success')
      } catch (error) {
        updateToggleUI('toggle-screen-inactivity', settings.screen_inactivity_reminder_enabled)
        showNotification('åˆ‡æ¢å¤±è´¥: ' + error, 'error')
      }
    })

    let screenInactivityTimer: number | null = null
    document.getElementById('screen-inactivity-minutes')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('screen-inactivity-display')
      if (displayEl) {
        displayEl.textContent = `${value} åˆ†é’Ÿ`
      }

      if (screenInactivityTimer !== null) {
        clearTimeout(screenInactivityTimer)
      }

      screenInactivityTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ screen_inactivity_minutes: value })
          showNotification(`æ— å˜åŒ–é˜ˆå€¼å·²æ›´æ–°ä¸º ${value} åˆ†é’Ÿ`, 'success')
        } catch (error) {
          showNotification('æ›´æ–°å¤±è´¥: ' + error, 'error')
        }
      }, 500)
    })

    document.getElementById('save-screen-inactivity')?.addEventListener('click', async () => {
      const msgEl = document.getElementById('screen-inactivity-message') as HTMLTextAreaElement
      if (!msgEl) return

      try {
        await updateSettings({ screen_inactivity_message: msgEl.value })
        showNotification('å±å¹•æ— å˜åŒ–æé†’å·²ä¿å­˜', 'success')
      } catch (error) {
        showNotification('ä¿å­˜å¤±è´¥: ' + error, 'error')
      }
    })

    // æ‰“å¼€å­˜å‚¨æ–‡ä»¶å¤¹
    document.getElementById('open-storage-folder')?.addEventListener('click', async () => {
      const settings = $settings.get()
      if (!settings) return

      try {
        await TauriAPI.openFolder(settings.storage_path)
      } catch (error) {
        showNotification('æ‰“å¼€æ–‡ä»¶å¤¹å¤±è´¥: ' + error, 'error')
      }
    })

    // å­˜å‚¨å®¹é‡é™åˆ¶æ»‘å—
    let storageLimitTimer: number | null = null
    document.getElementById('storage-limit')?.addEventListener('input', (e) => {
      const value = parseInt((e.target as HTMLInputElement).value)
      const displayEl = document.getElementById('storage-limit-display')
      if (displayEl) {
        displayEl.textContent = `${value} MB`
      }

      if (storageLimitTimer !== null) {
        clearTimeout(storageLimitTimer)
      }

      storageLimitTimer = window.setTimeout(async () => {
        try {
          await updateSettings({ storage_limit_mb: value })
          showNotification(`å­˜å‚¨å®¹é‡é™åˆ¶å·²æ›´æ–°ä¸º ${value} MB`, 'success')
        } catch (error) {
          showNotification('æ›´æ–°å¤±è´¥: ' + error, 'error')
        }
      }, 500)
    })

    // ========================================================================
    // AI é…ç½®
    // ========================================================================

    let useCustomModel = false

    async function loadAIConfig() {
      try {
        // åŠ è½½é¢„è®¾æ¨¡å‹åˆ—è¡¨
        const models = await TauriAPI.getAvailableAIProviders()
        populateModelSelect(models)

        // åŠ è½½å·²é…ç½®çš„æä¾›å•†
        const config = await TauriAPI.getAIConfig()
        renderProviderList(config)
      } catch (error) {
        console.error('Failed to load AI config:', error)
      }
    }

    function populateModelSelect(models: any[]) {
      const select = document.getElementById('new-provider-model-select') as HTMLSelectElement
      if (!select) return

      select.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾æ¨¡å‹...</option>'

      // æŒ‰æä¾›å•†åˆ†ç»„
      const grouped: Record<string, any[]> = {}
      models.forEach((m) => {
        if (!grouped[m.provider]) grouped[m.provider] = []
        grouped[m.provider].push(m)
      })

      Object.entries(grouped).forEach(([provider, providerModels]) => {
        const group = document.createElement('optgroup')
        group.label = provider
        providerModels.forEach((m) => {
          const option = document.createElement('option')
          option.value = m.id
          option.textContent = `${m.name}${m.is_free ? ' (Free)' : ''}`
          group.appendChild(option)
        })
        select.appendChild(group)
      })
    }

    // è‡ªå®šä¹‰æ¨¡å‹åˆ‡æ¢
    document.getElementById('toggle-custom-model')?.addEventListener('click', () => {
      useCustomModel = !useCustomModel
      const selectEl = document.getElementById('new-provider-model-select') as HTMLElement
      const customEl = document.getElementById('new-provider-model-custom') as HTMLElement
      const toggleBtn = document.getElementById('toggle-custom-model') as HTMLElement

      if (useCustomModel) {
        selectEl.classList.add('hidden')
        customEl.classList.remove('hidden')
        toggleBtn.textContent = 'é¢„è®¾'
      } else {
        selectEl.classList.remove('hidden')
        customEl.classList.add('hidden')
        toggleBtn.textContent = 'è‡ªå®šä¹‰'
      }
    })

    // API Key å¯è§æ€§åˆ‡æ¢
    document.getElementById('toggle-key-visibility')?.addEventListener('click', () => {
      const input = document.getElementById('new-provider-key') as HTMLInputElement
      input.type = input.type === 'password' ? 'text' : 'password'
    })

    // è·å–è¡¨å•æ•°æ®
    function getFormData() {
      const name = (document.getElementById('new-provider-name') as HTMLInputElement).value.trim()
      const url = (document.getElementById('new-provider-url') as HTMLInputElement).value.trim()
      const key = (document.getElementById('new-provider-key') as HTMLInputElement).value.trim()

      let model = ''
      if (useCustomModel) {
        model = (document.getElementById('new-provider-model-custom') as HTMLInputElement).value.trim()
      } else {
        model = (document.getElementById('new-provider-model-select') as HTMLSelectElement).value
      }

      return { name, url, key, model }
    }

    function validateForm(data: ReturnType<typeof getFormData>): string | null {
      if (!data.name) return 'è¯·è¾“å…¥æä¾›å•†åç§°'
      if (!data.url) return 'è¯·è¾“å…¥ API åœ°å€'
      if (!data.url.startsWith('http://') && !data.url.startsWith('https://')) {
        return 'API åœ°å€å¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´'
      }
      if (!data.model) return 'è¯·é€‰æ‹©æˆ–è¾“å…¥æ¨¡å‹'
      if (!data.key) return 'è¯·è¾“å…¥ API Key'
      return null
    }

    function clearForm() {
      ;(document.getElementById('new-provider-name') as HTMLInputElement).value = ''
      ;(document.getElementById('new-provider-url') as HTMLInputElement).value = ''
      ;(document.getElementById('new-provider-key') as HTMLInputElement).value = ''
      ;(document.getElementById('new-provider-model-select') as HTMLSelectElement).value = ''
      ;(document.getElementById('new-provider-model-custom') as HTMLInputElement).value = ''
    }

    // æ·»åŠ æä¾›å•†
    document.getElementById('btn-add-provider')?.addEventListener('click', async () => {
      const data = getFormData()
      const error = validateForm(data)
      if (error) {
        showNotification(error, 'error')
        return
      }

      // ç”Ÿæˆ ID: name çš„ kebab-case + æ—¶é—´æˆ³
      const id = data.name.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now()

      try {
        const providerConfig: AIProviderConfig = {
          id,
          name: data.name,
          api_base_url: data.url,
          api_key: data.key,
          model: data.model,
          enabled: true,
          is_active: false,
        }

        await TauriAPI.updateAIProviderConfig(providerConfig)
        showNotification(`å·²æ·»åŠ æä¾›å•†: ${data.name}`, 'success')

        clearForm()

        // é‡æ–°åŠ è½½åˆ—è¡¨
        const config = await TauriAPI.getAIConfig()

        // å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªæä¾›å•†ï¼Œè‡ªåŠ¨æ¿€æ´»
        if (config.providers.length === 1) {
          await TauriAPI.setActiveAIProvider(id)
        }

        const updatedConfig = await TauriAPI.getAIConfig()
        renderProviderList(updatedConfig)
      } catch (err) {
        showNotification('æ·»åŠ å¤±è´¥: ' + err, 'error')
      }
    })

    // æµ‹è¯•æ–°æä¾›å•†è¿æ¥ï¼ˆä¸ä¿å­˜ï¼‰
    document.getElementById('btn-test-new-provider')?.addEventListener('click', async () => {
      const data = getFormData()
      const error = validateForm(data)
      if (error) {
        showNotification(error, 'error')
        return
      }

      // å…ˆä¸´æ—¶æ·»åŠ ï¼Œæµ‹è¯•ï¼Œç„¶åçœ‹ç»“æœ
      const tempId = '__test_temp_' + Date.now()

      try {
        showNotification('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info')

        const providerConfig: AIProviderConfig = {
          id: tempId,
          name: data.name,
          api_base_url: data.url,
          api_key: data.key,
          model: data.model,
          enabled: true,
          is_active: false,
        }

        // æ·»åŠ ä¸´æ—¶æä¾›å•†
        await TauriAPI.updateAIProviderConfig(providerConfig)

        // æµ‹è¯•è¿æ¥
        try {
          const result = await TauriAPI.testAIConnection(tempId)
          showNotification('è¿æ¥æˆåŠŸ: ' + result, 'success')
        } catch (testErr) {
          showNotification('è¿æ¥å¤±è´¥: ' + testErr, 'error')
        }

        // åˆ é™¤ä¸´æ—¶æä¾›å•† - é€šè¿‡é‡ç½®åé‡æ–°åŠ è½½
        // æ³¨æ„ï¼šåç«¯æ²¡æœ‰ delete å•ä¸ª provider çš„å‘½ä»¤ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ª
        // æš‚æ—¶ä¿ç•™ä¸´æ—¶æä¾›å•†ï¼Œç”¨æˆ·å¯ä»¥æ‰‹åŠ¨åˆ é™¤
      } catch (err) {
        showNotification('æµ‹è¯•å¤±è´¥: ' + err, 'error')
      }
    })

    // æ¸²æŸ“å·²é…ç½®çš„æä¾›å•†åˆ—è¡¨
    function renderProviderList(config: AIConfig) {
      const container = document.getElementById('ai-providers-list')
      if (!container) return

      container.innerHTML = ''

      if (config.providers.length === 0) {
        container.innerHTML = `
          <div class="text-center py-8">
            <p class="text-muted">æš‚æ— å·²é…ç½®çš„æä¾›å•†</p>
            <p class="text-xs text-muted mt-2">åœ¨ä¸Šæ–¹æ·»åŠ ä½ çš„ç¬¬ä¸€ä¸ª AI æä¾›å•†</p>
          </div>
        `
        return
      }

      config.providers.forEach((provider) => {
        const isActive = config.active_provider_id === provider.id
        const row = document.createElement('div')
        row.className = `flex items-center justify-between p-4 rounded-xl mb-3 ${
          isActive ? 'bg-input border border-glow' : 'bg-input border border-secondary'
        }`

        // é®è”½ API Key
        const maskedKey = provider.api_key.length > 8
          ? provider.api_key.slice(0, 4) + '****' + provider.api_key.slice(-4)
          : '****'

        row.innerHTML = `
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2">
              <span class="text-sm font-medium text-primary">${provider.name}</span>
              ${isActive ? '<span class="text-xs text-success">[æ´»è·ƒ]</span>' : ''}
            </div>
            <div class="text-xs text-muted mt-1 truncate">
              ${provider.model} Â· ${maskedKey}
            </div>
            <div class="text-xs text-muted truncate">${provider.api_base_url}</div>
          </div>
          <div class="flex items-center gap-2 ml-4 shrink-0">
            ${!isActive ? `
              <button class="btn-activate text-xs px-3 py-1.5 bg-secondary rounded-lg text-success hover:bg-input transition-colors" data-id="${provider.id}">
                æ¿€æ´»
              </button>
            ` : ''}
            <button class="btn-test text-xs px-3 py-1.5 bg-secondary rounded-lg text-primary hover:bg-input transition-colors" data-id="${provider.id}">
              æµ‹è¯•
            </button>
            <button class="btn-delete text-xs px-3 py-1.5 bg-secondary rounded-lg text-red-400 hover:bg-input transition-colors" data-id="${provider.id}" data-name="${provider.name}">
              åˆ é™¤
            </button>
          </div>
        `

        // ç»‘å®šäº‹ä»¶
        row.querySelector('.btn-activate')?.addEventListener('click', async () => {
          try {
            await TauriAPI.setActiveAIProvider(provider.id)
            showNotification(`å·²æ¿€æ´» ${provider.name}`, 'success')
            const updated = await TauriAPI.getAIConfig()
            renderProviderList(updated)
          } catch (err) {
            showNotification('æ¿€æ´»å¤±è´¥: ' + err, 'error')
          }
        })

        row.querySelector('.btn-test')?.addEventListener('click', async () => {
          try {
            showNotification('æ­£åœ¨æµ‹è¯•...', 'info')
            const result = await TauriAPI.testAIConnection(provider.id)
            showNotification('è¿æ¥æˆåŠŸ: ' + result, 'success')
          } catch (err) {
            showNotification('è¿æ¥å¤±è´¥: ' + err, 'error')
          }
        })

        row.querySelector('.btn-delete')?.addEventListener('click', async () => {
          const name = provider.name
          if (!confirm(`ç¡®å®šè¦åˆ é™¤æä¾›å•† "${name}" å—ï¼Ÿ`)) return

          try {
            await TauriAPI.deleteAIProvider(provider.id)
            showNotification(`å·²åˆ é™¤ ${name}`, 'success')
            const updated = await TauriAPI.getAIConfig()
            renderProviderList(updated)
          } catch (err) {
            showNotification('åˆ é™¤å¤±è´¥: ' + err, 'error')
          }
        })

        container.appendChild(row)
      })
    }

    // ========================================================================
    // é€šçŸ¥
    // ========================================================================

    function showNotification(message: string, type: 'success' | 'error' | 'info') {
      const notification = document.createElement('div')
      notification.className = `fixed bottom-4 right-4 px-6 py-3 rounded-[12px] text-white font-medium z-50 transition-all
        ${type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'}`
      notification.textContent = message
      document.body.appendChild(notification)

      setTimeout(() => {
        notification.remove()
      }, 3000)
    }

    // ========================================================================
    // å¯åŠ¨
    // ========================================================================

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init)
    } else {
      init()
    }
  </script>
</Layout>
